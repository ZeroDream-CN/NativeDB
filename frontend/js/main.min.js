const API_BASE=document.querySelector('meta[name="api-base"]')?.content||window.location.origin;let allNatives=[],currentNativeHash=null,currentNativeParams=[],currentNativeExamples={},authToken=localStorage.getItem("native_db_token")||null,currentUser=null,transEditor=null,codeEditor=null,monacoLoaded=!1,renderQueue=[],renderedCount=0,currentThemeColor="blue",currentThemeBg="gray";const BATCH_SIZE=100;let userSettings={game:"fivem",lang:"raw",theme:"blue",highlight:"tomorrow"};function loadDefaultDocument(e){fetch(e).then((e=>e.text())).then((e=>{$("#empty-state").removeClass("items-center justify-center text-gray-600").addClass("justify-start prose prose-invert prose-sm max-w-none text-gray-400 break-words p-6 overflow-y-auto"),$("#empty-state").html(marked.parse(e))})).catch((e=>{}))}function loadSettings(){const e=localStorage.getItem("ndb_settings");if(e)try{userSettings={...userSettings,...JSON.parse(e)},loadTheme(userSettings.theme||"blue"),loadHighlight(userSettings.highlight||"tomorrow")}catch(e){}}function saveSettings(){localStorage.setItem("ndb_settings",JSON.stringify(userSettings))}function loadTheme(e){if("zinc"==currentThemeColor&&"zinc"!=e)Swal.fire({icon:"warning",title:"注意",text:"从该主题切换到其他主题需要刷新页面才能生效。",showCancelButton:!1,confirmButtonText:"刷新页面"}).then((e=>{e.isConfirmed&&location.reload()}));else{$(`[class*="${currentThemeColor}"]`).each(((t,a)=>{let n=$(a).attr("class");n.includes("theme-not-change")||(n=n.replace(new RegExp(currentThemeColor,"g"),e),$(a).attr("class",n))}));let t={blue:"gray",red:"zinc",orange:"stone",yellow:"stone",green:"neutral",purple:"slate",zinc:"zinc"};$(`[class*="bg-${currentThemeBg}"]`).each(((a,n)=>{let r=$(n).attr("class");r.includes("theme-not-change")||(r=r.replace(new RegExp(`bg-${currentThemeBg}`,"g"),`bg-${t[e]}`),$(n).attr("class",r))})),$(`[class*="border-${currentThemeBg}"]`).each(((a,n)=>{let r=$(n).attr("class");r.includes("theme-not-change")||(r=r.replace(new RegExp(`border-${currentThemeBg}`,"g"),`border-${t[e]}`),$(n).attr("class",r))}));let a={blue:"#345baf",red:"#c34c4c",orange:"#e17100",yellow:"#c79c2d",green:"#789f3c",purple:"#8a63b0",zinc:"#626262"};$("body").css("--theme-color",a[e]),currentThemeColor=e,currentThemeBg=t[e]}}function loadHighlight(e){"tomorrow"==e||"okaidia"==e?$("#highlight-theme").attr("href",`https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-${e}.min.css`):$("#highlight-theme").attr("href",`https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-${e}.min.css`)}function initMonaco(){"undefined"!=typeof require&&(require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs"}}),require(["vs/editor/editor.main"],(function(){monacoLoaded=!0;const e=document.getElementById("editor-trans-cn");e&&(transEditor=monaco.editor.create(e,{value:"",language:"markdown",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on",fontSize:14,fontFamily:"'JetBrains Mono', Consolas, monospace"}));const t=document.getElementById("editor-code-content");t&&(codeEditor=monaco.editor.create(t,{value:"",language:"lua",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!0},scrollBeyondLastLine:!1,fontSize:14,fontFamily:"'JetBrains Mono', Consolas, monospace"}))})))}function updateCodeEditorLang(e){if(!codeEditor||!monacoLoaded)return;let t="lua";switch(e){case"c#":t="csharp";break;case"javascript":t="javascript";break;default:t="lua"}monaco.editor.setModelLanguage(codeEditor.getModel(),t)}function getAuthHeader(){return authToken?{Authorization:`Bearer ${authToken}`}:{}}async function checkLoginStatus(){if(authToken)try{const e=await fetch(`${API_BASE}/api/auth/me`,{headers:getAuthHeader()});e.ok?(currentUser=await e.json(),updateAuthUI(!0)):logout(!1)}catch(e){updateAuthUI(!1)}else updateAuthUI(!1)}function updateAuthUI(e){e&&currentUser?($("#btn-login").addClass("hidden"),$("#user-info").removeClass("hidden").addClass("flex"),$("#user-name").text(currentUser.username),$("#user-avatar").attr("src",currentUser.avatar),$("#btn-edit-trans").removeClass("hidden"),$("#btn-edit-code").removeClass("hidden"),$("#btn-edit-params").removeClass("hidden")):($("#btn-login").removeClass("hidden"),$("#user-info").addClass("hidden").removeClass("flex"),$("#btn-edit-trans").addClass("hidden"),$("#btn-edit-code").addClass("hidden"),$("#btn-edit-params").addClass("hidden"))}async function doLogin(){const e=$("#input-username").val().trim(),t=$("#input-password").val().trim();if(e&&t)try{const a=await fetch(`${API_BASE}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),n=await a.json();a.ok?(authToken=n.token,currentUser=n.user,localStorage.setItem("native_db_token",authToken),$("#modal-login").addClass("hidden"),$("#input-username").val(""),$("#input-password").val(""),updateAuthUI(!0),sendNotification("success",`欢迎回来, ${currentUser.username}`)):Swal.fire({icon:"error",title:"登录失败",theme:"material-ui-dark",text:n.error||"用户名或密码错误"})}catch(e){Swal.fire({icon:"error",title:"错误",theme:"material-ui-dark",text:"网络请求出错: "+e.message})}else Swal.fire({icon:"error",title:"错误",theme:"material-ui-dark",text:"请输入用户名和密码"})}async function submitChangePassword(){const e=$("#input-old-pass").val(),t=$("#input-new-pass").val(),a=$("#input-confirm-pass").val();if(e&&t&&a)if(t===a)if(t.length<6)Swal.fire({icon:"error",title:"错误",text:"新密码长度至少需要6位"});else try{const a=await fetch(`${API_BASE}/api/auth/change-password`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({old_password:e,new_password:t})}),n=await a.json();a.ok?(Swal.fire({icon:"success",title:"成功",text:"密码修改成功"}),$("#modal-change-pass").addClass("hidden")):Swal.fire({icon:"error",title:"错误",text:n.error||"修改失败"})}catch(e){Swal.fire({icon:"error",title:"错误",text:"网络请求失败: "+e.message})}else Swal.fire({icon:"error",title:"错误",text:"两次输入的新密码不一致"});else Swal.fire({icon:"error",title:"错误",text:"请填写所有字段"})}function logout(e=!0){authToken=null,currentUser=null,localStorage.removeItem("native_db_token"),e?location.reload():updateAuthUI(!1)}function sendNotification(e,t,a){Swal.fire({icon:e,theme:"material-ui-dark",text:t,showConfirmButton:!1,timer:2e3,position:"top-end"}).then((()=>{a&&a()}))}async function fetchNatives(){try{const e=await fetch(`${API_BASE}/api/natives`);if(!e.ok)throw new Error("API Error");allNatives=await e.json(),$("#status-bar").text(`已加载 ${allNatives.length} 个函数`),initFilters(),filterData();const t=window.location.hash.slice(2);t&&selectNative(t)}catch(e){$("#natives-list").html(`<div class="p-10 text-center text-red-500">加载函数失败<br>${e.message}</div>`)}}async function selectNative(e){currentNativeHash=e,currentNativeExamples={},$(".native-row").removeClass("active"),$(`#row-${e}`).addClass("active"),$("#empty-state").removeClass("md:flex").addClass("hidden"),$("#detail-container").removeClass("hidden"),$("#detail-view").removeClass("translate-x-full"),window.innerWidth<768&&$("body").addClass("overflow-hidden");const t=allNatives.find((t=>t.hash===e));t&&renderDetailBasic(t);try{const a=await fetch(`${API_BASE}/api/native/${e}`),n=await a.json();n.data&&(t&&(t.description_cn=n.data.description_cn,t.params=n.data.params,t.name_sp=n.data.name_sp),renderDetailFull(n.data,n.source_available),window.location.hash=`_${e}`)}catch(e){}}function closeMobileDetail(){$("#detail-view").addClass("translate-x-full"),$("body").removeClass("overflow-hidden"),$(".native-row").removeClass("active"),currentNativeHash=null,currentNativeExamples={},window.location.hash="",window.history.replaceState({},document.title,window.location.pathname)}function renderDetailBasic(e){currentNativeParams=e.params||[];let t=e.name||e.hash;"gta5"===userSettings.game&&e.name_sp&&(t=e.name_sp),"raw"!==userSettings.lang&&(t=toPascalCase(t)),t.startsWith("0x")&&(t="N_0x"+t.substring(2).toUpperCase()),$("#detail-name").text(t),$("#detail-namespace").text(e.namespace),$("#detail-apiset").text(getApisetName(e.apiset)).attr("class",`px-2 py-0.5 rounded text-xs font-semibold border ${getApisetColor(e.apiset)}`),$("#detail-hash").text(e.hash),e.jhash?($("#detail-jhash").removeClass("hidden"),$("#detail-jhash").text(e.jhash)):$("#detail-jhash").addClass("hidden");let a="";if("raw"===userSettings.lang){const n=e.params.map((e=>`${e.type} ${e.name}`)).join(", ");a=`// ${t.startsWith("N_")?e.hash:toPascalCase(t)}\n${e.return_type} ${e.name||e.hash} (${n})`}else if("lua"===userSettings.lang){let n=e.params.length>0?"\n\t\t":"";e.params.forEach((t=>{"char*"!==t.type&&t.type.includes("*")||(n+=`${t.name} --[[ ${mapLuaType(t.type,!0).replace("*","")} ]], `,e.params.length>1&&(n+="\n\t\t"))})),n=n.slice(0,e.params.length>1?-5:-2);const r=mapLuaType(e.return_type);"void"==r?a=`${t}(${n}${e.params.length>0?"\n":""})`:(a=`local retval --[[ ${r} ]]`,e.params.forEach((e=>{e.type.includes("*")&&"char*"!==e.type&&(a+=`, \n\t${e.name} --[[ ${mapLuaType(e.type,!0).replace("*","")} ]]`)})),a+=` =\n\t${t}(${n}${e.params.length>0?"\n\t":""})`),a=`-- ${e.name||e.hash}\n${a}`}else if("javascript"===userSettings.lang){const n=mapJavascriptType(e.return_type,!0);let r="void"===n?e.params.length>0?"\n\t":"":e.params.length>0?"\n\t\t":"",s=0;e.params.forEach((t=>{"char*"!==t.type&&t.type.includes("*")?s++:(r+=`${t.name}: ${mapJavascriptType(t.type,!0).replace("*","")}, `,e.params.length>1&&(r+="void"===n?"\n\t":"\n\t\t"))})),r=r.slice(0,e.params.length>1?"void"===n?-4:-5:-2),"void"==n?a=`${t}(${r}${e.params.length>0?"\n":""})`:(a="const ",s>0&&(a+="["),a+="retval",e.params.forEach((e=>{e.type.includes("*")&&"char*"!==e.type&&(a+=`, ${e.name}`)})),s>0&&(a+="]"),a+=": ",s>0&&(a+="["),a+=n,e.params.forEach((e=>{e.type.includes("*")&&"char*"!==e.type&&(a+=`, ${mapJavascriptType(e.type,!0).replace("*","")}`)})),s>0&&(a+="]"),a+=` = \n\t${t}(${r}${e.params.length>0?"\n\t":""});`),a=`// ${e.name||e.hash}\n${a}`}else if("c#"===userSettings.lang){const n=mapCSharpType(e.return_type);let r="";e.params.forEach((e=>{e.type.includes("*")&&"char*"!==e.type?r+=`, \n\tref ${mapCSharpType(e.type)} ${e.name}`:r+=`, \n\t${mapCSharpType(e.type)} ${e.name}`})),r+=e.params.length>0?"\n":"",a=`// ${e.name||e.hash}\n${n} ${t}(${r.slice(2)})`}const n=$("#detail-definition");n.removeClass().addClass(`language-${"raw"===userSettings.lang?"cpp":userSettings.lang.replace("c#","csharp")}`),n.text(a),Prism.highlightElement(n[0]),renderParams(e.params),$("#detail-desc-cn").html('<span class="text-gray-600 italic">加载中...</span>'),$("#detail-desc-en").html(""),switchTab("example"),$("#source-code-viewer").text("// 点击 '底层源码' 标签以加载函数的底层代码。")}function mapCSharpType(e){if(!e)return"object";const t=e.toLowerCase().replace("*","");let a="";return"void"===t&&(a="void"),"bool"!==t&&"boolean"!==t||(a="bool"),"int"===t&&(a="int"),"float"===t&&(a="float"),"char"!==t&&"char*"!==t||(a="string"),"vector3"===t&&(a="Vector3"),"entity"===t&&(a="int /* Entity */"),"ped"===t&&(a="int /* Ped */"),"vehicle"===t&&(a="int /* Vehicle */"),"player"===t&&(a="int /* Player */"),"object"===t&&(a="int /* Object */"),"any"===t&&(a="Any"),e.includes("*")&&(a=`ref ${a}`),a}function mapLuaType(e,t){if(!e)return"object";if(e.includes("*")&&"char*"!==e&&!t)return!1;const a=e.toLowerCase();return"void"===a?"void":"bool"===a||"boolean"===a?"boolean":"int"===a||"float"===a?"number":"char"===a||"char*"===a?"string":"vector3"===a?"Vector3":"entity"===a?"Entity":"ped"===a?"Ped":"vehicle"===a?"Vehicle":"player"===a?"Player":"object"===a?"Object":"any"===a?"Any":e}function mapJavascriptType(e,t){if(!e)return"object";if(e.includes("*")&&"char*"!==e&&!t)return!1;const a=e.toLowerCase();return"void"===a?"void":"bool"===a||"boolean"===a?"boolean":"int"===a||"int*"===a?"int":"float"===a||"float*"===a?"float":"char"===a||"char*"===a?"string":"vector3"===a||"vector3*"===a?"[float, float, float]":"entity"===a?"Entity":"ped"===a?"Ped":"vehicle"===a?"Vehicle":"player"===a?"Player":"object"===a?"Object":"any"===a?"Any":e}function toCamelCase(e){return e?e.toLowerCase().split("_").map(((e,t)=>0===t?e:e.charAt(0).toUpperCase()+e.slice(1))).join(""):""}function toPascalCase(e){return e?e.toLowerCase().split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(""):""}function renderParams(e){const t=$("#detail-params-list");t.empty(),e.forEach((e=>{let a=e.description_cn||e.description||"",n=marked.parse(a).replace(/<p>/g,"").replace(/<\/p>/g,""),r=e.type;if("javascript"===userSettings.lang?r=mapJavascriptType(e.type):"c#"===userSettings.lang?r=mapCSharpType(e.type):"lua"===userSettings.lang&&(r=mapLuaType(e.type)),!r)return;const s=`\n                    <li class="param-item">\n                        <span class="text-zinc-400 mr-1 param-type type-${e.type}">${r}</span>\n                        <span class="text-white font-bold mr-1 param-name">${e.name}:</span>\n                        <span class="param-desc">${n}</span>\n                    </li>\n                `;t.append(s)})),0===e.length&&$("#detail-params-list").html('<li class="text-gray-500 italic">此函数没有参数。</li>')}function renderDetailFull(e,t){currentNativeParams=e.params||[],renderParams(currentNativeParams),e.description_cn&&""!==e.description_cn.trim()?$("#detail-desc-cn").html(marked.parse(e.description_cn)):e.description_original?$("#detail-desc-cn").html(marked.parse(e.description_original)):$("#detail-desc-cn").html('<span class="text-gray-600">暂无描述信息。</span>'),e.description_original&&$("#detail-desc-en").html(marked.parse(e.description_original)),$("#detail-desc-cn pre code, #detail-desc-en pre code").each(((e,t)=>Prism.highlightElement(t))),$("#detail-desc-en a, #detail-desc-cn a").each(((e,t)=>{const a=$(t).attr("href");a.startsWith("#")||a.startsWith("/")||$(t).attr("target","_blank")})),$("#tab-btn-source").attr("data-has-source",t?"true":"false"),t?$("#source-code-viewer").text("// 点击 '底层源码' 标签以加载函数的底层代码。"):$("#source-code-viewer").text("-- 数据库中暂无该函数的底层代码。"),authToken&&currentUser&&updateAuthUI(!0)}function formatCode(e){return js_beautify(e,{indent_size:4,indent_char:" ",brace_style:"collapse",preserve_newlines:!0,e4x:!0}).replaceAll(" - > ","->")}function cleanupCode(e){return e.split("\n").map((e=>e.trim())).join("\n")}async function loadSourceCode(e){const t=$("#source-code-viewer");t.text("// 正在加载中，请稍候...");try{const a=await fetch(`${API_BASE}/api/native/${e}/source`);if(404===a.status)return void t.text("// 数据库中暂无该函数的底层代码。");const n=await a.json(),r="cpp"==n.lang?cleanupCode(n.content):n.content;t.text("cpp"==n.lang?formatCode(r):r),t.removeClass().addClass(`language-${n.lang}`),Prism.highlightElement(t[0])}catch(e){t.text("// 加载底层代码时发生错误。")}}async function loadExampleCode(e){const t=$("#example-code-viewer"),a=$("#example-lang-switches");t.text("// 正在加载中，请稍候..."),a.addClass("hidden").empty(),currentNativeExamples={};try{const n=await fetch(`${API_BASE}/api/native/${e}/example`);if(404===n.status)return void t.text("-- 数据库中暂无该函数的示例代码。");const r=await n.json();Array.isArray(r)&&r.forEach((e=>{e.language&&e.code&&(currentNativeExamples[e.language.toLowerCase()]=e.code)}));const s=Object.keys(currentNativeExamples);s.length>0?(a.removeClass("hidden"),s.forEach(((e,t)=>{const n=$(`<button class="px-2 py-1 text-xs rounded border transition-colors ${0===t?`bg-${currentThemeColor}-600 border-${currentThemeColor}-500 text-white`:`bg-${currentThemeBg}-800 border-${currentThemeBg}-600 text-${currentThemeBg}-400 hover:text-${currentThemeBg}-200 hover:bg-${currentThemeBg}-700`}">${formatLangName(e)}</button>`);n.click((function(){a.children().removeClass(`bg-${currentThemeColor}-600 border-${currentThemeColor}-500 text-white`).addClass(`bg-${currentThemeBg}-800 border-${currentThemeBg}-600 text-${currentThemeBg}-400 hover:text-${currentThemeBg}-200 hover:bg-${currentThemeBg}-700`),$(this).removeClass(`bg-${currentThemeBg}-800 border-${currentThemeBg}-600 text-${currentThemeBg}-400 hover:text-${currentThemeBg}-200 hover:bg-${currentThemeBg}-700`).addClass(`bg-${currentThemeColor}-600 border-${currentThemeColor}-500 text-white`),showExampleCode(e)})),a.append(n)})),showExampleCode(s[0])):t.text("-- 数据库中暂无该函数的示例代码。")}catch(e){t.text("// 加载示例代码时发生错误。"),currentNativeExamples={}}}function showExampleCode(e){const t=$("#example-code-viewer"),a=currentNativeExamples[e]||"-- 无代码";t.text(a),t.removeClass().addClass(`language-${e}`),Prism.highlightElement(t[0])}function formatLangName(e){return"cs"===(e=e.toLowerCase())||"c#"===e?"C#":"lua"===e?"Lua":"javascript"===e||"js"===e?"JavaScript":e.toUpperCase()}async function submitTranslation(){if(!currentNativeHash)return;const e=transEditor?transEditor.getValue():$("#input-trans-cn").val(),t=`/api/native/${currentNativeHash}/translate`;try{const a=await fetch(`${API_BASE}${t}`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({description_cn:e})});if(a.ok){sendNotification("success","翻译保存成功！"),selectNative(currentNativeHash);const t=allNatives.find((e=>e.hash===currentNativeHash));t&&(t.description_cn=e),$("#modal-trans").addClass("hidden")}else{const e=await a.json();Swal.fire({icon:"error",title:"错误",text:"保存失败: "+(e.error||"未知错误")})}}catch(e){Swal.fire({icon:"error",title:"错误",text:"请求失败: "+e.message})}}async function submitExample(){if(!currentNativeHash)return;const e=$("#input-code-lang").val(),t=codeEditor?codeEditor.getValue():$("#input-code-content").val(),a=`/api/native/${currentNativeHash}/example`;try{const n=await fetch(`${API_BASE}${a}`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({language:e,code:t})});if(n.ok)sendNotification("success","示例代码保存成功！"),$("#modal-code").addClass("hidden"),loadExampleCode(currentNativeHash);else{const e=await n.json();Swal.fire({icon:"error",title:"错误",text:"保存失败: "+e.error})}}catch(e){Swal.fire({icon:"error",title:"错误",text:"请求失败: "+e.message})}}function openParamsEditor(){const e=$("#params-edit-container");e.empty(),currentNativeParams&&0!==currentNativeParams.length?currentNativeParams.forEach(((t,a)=>{const n=t.description||"(无原始描述)",r=t.description_cn||"",s=`\n                <div class="bg-${currentThemeBg}-900 border border-${currentThemeBg}-700 p-3 rounded">\n                    <div class="flex items-center gap-2 mb-2">\n                        <span class="text-${currentThemeColor}-400 font-mono text-xs font-bold">${t.type}</span>\n                        <span class="text-white font-mono text-sm font-bold">${t.name}</span>\n                    </div>\n                    <div class="mb-2 text-xs text-${currentThemeBg}-500 bg-${currentThemeBg}-950 p-2 rounded border border-${currentThemeBg}-800">\n                        <span class="font-bold text-${currentThemeBg}-600 select-none">Original: </span>\n                        ${n}\n                    </div>\n                    <input type="text" \n                        class="param-input w-full bg-${currentThemeBg}-800 border border-${currentThemeBg}-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-${currentThemeColor}-500" \n                        placeholder="输入中文描述..." \n                        data-name="${t.name}" \n                        value="${r.replace(/"/g,"&quot;")}">\n                </div>\n            `;e.append(s)})):e.html('<div class="text-center text-gray-500 py-4">此函数没有参数，无需翻译。</div>'),$("#modal-params").removeClass("hidden")}async function submitParams(){if(!currentNativeHash)return;const e=[];$(".param-input").each((function(){const t=$(this).data("name"),a=$(this).val().trim();t&&e.push({name:t,description_cn:a})}));const t=`/api/native/${currentNativeHash}/params`;try{const a=await fetch(`${API_BASE}${t}`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({params:e})});if(a.ok){sendNotification("success","参数翻译保存成功！"),$("#modal-params").addClass("hidden"),selectNative(currentNativeHash);const t=allNatives.find((e=>e.hash===currentNativeHash));t&&t.params&&t.params.forEach((t=>{const a=e.find((e=>e.name===t.name));a&&(t.description_cn=a.description_cn)}))}else{const e=await a.json();Swal.fire({icon:"error",title:"错误",text:"保存失败: "+e.error})}}catch(e){Swal.fire({icon:"error",title:"错误",text:"请求失败: "+e.message})}}function initFilters(){const e=[...new Set(allNatives.map((e=>e.namespace)))].sort(),t=$("#filter-namespace");t.find('option:not([value="all"])').remove(),e.forEach((e=>t.append(`<option value="${e}">${e}</option>`)))}function filterData(){const e=$("#search-input").val().toLowerCase(),t=$("#filter-apiset").val(),a=$("#filter-namespace").val();let n=allNatives.filter((n=>{let r=n.hash.toLowerCase().includes(e);n.name&&n.name.toLowerCase().includes(e)&&(r=!0),n.name_sp&&n.name_sp.toLowerCase().includes(e)&&(r=!0),n.name&&n.name.toLowerCase().replace(/_/g,"").includes(e)&&(r=!0);const s="all"===t||n.apiset===t,o="all"===a||n.namespace===a;return r&&s&&o}));n.sort(((e,t)=>e.namespace!==t.namespace?e.namespace.localeCompare(t.namespace):e.name.localeCompare(t.name))),renderQueue=[];let r=null;n.forEach((e=>{e.namespace!==r&&(renderQueue.push({type:"header",text:e.namespace}),r=e.namespace),renderQueue.push({type:"row",data:e})}));const s=$("#natives-list");s.empty(),renderedCount=0,0===renderQueue.length?s.html('<div class="p-10 text-center text-gray-500">暂无符合条件的函数。</div>'):(renderNextBatch(),s.scrollTop(0))}function renderNextBatch(){if(renderedCount>=renderQueue.length)return;const e=Math.min(renderedCount+100,renderQueue.length);let t="";for(let a=renderedCount;a<e;a++){const e=renderQueue[a];if("header"===e.type)t+=`\n                <div class="sticky top-0 bg-${currentThemeBg}-800/95 backdrop-blur border-b border-t border-${currentThemeBg}-700 px-4 py-1.5 text-xs font-bold text-${currentThemeBg}-400 uppercase tracking-wider z-0">\n                    ${e.text}\n                </div>\n            `;else{const a=e.data,n=a.params||[],r=n.map(((e,t)=>{const a=t===n.length-1;let r=e.type;return"javascript"===userSettings.lang?r=mapJavascriptType(e.type):"c#"===userSettings.lang?r=mapCSharpType(e.type):"lua"===userSettings.lang&&(r=mapLuaType(e.type)),0==r?"":`<span class="text-gray-400">${getGenericTypeColor(e.type)}${r}</span> <span class="text-gray-300 group-hover:text-white">${e.name}</span>${a?"":", "}`})).join("");let s=a.name||a.hash;"gta5"===userSettings.game&&a.name_sp&&(s=a.name_sp),"raw"!==userSettings.lang?(s=toPascalCase(s),s.startsWith("0x")&&(s="N_0x"+s.substring(2).toUpperCase())):s.startsWith("0x")&&(s="0x"+s.substring(2).toUpperCase());const o=currentNativeHash===a.hash?"active":"";let i="";a.source_available&&(i+='<i class="fas fa-code text-yellow-400 text-xs ml-1" title="底层源码"></i>'),a.example_available&&(i+='<i class="fas fa-file-alt text-green-400 text-xs ml-1" title="示例代码"></i>'),t+=`\n                <div class="native-row cursor-pointer px-4 py-1.5 border-b border-${currentThemeBg}-700/50 flex items-baseline gap-3 transition-colors group ${o}" \n                        onclick="location.hash='#_${a.hash}'" id="row-${a.hash}">\n                    <span class="text-xs font-mono font-bold shrink-0 w-16 text-right ${getTypeColorClass(a.return_type)}">${a.return_type}</span>\n                    <div class="flex-1 overflow-hidden whitespace-nowrap text-ellipsis font-mono text-sm text-gray-300 font-medium truncate">\n                        <span class="text-gray-100 group-hover:text-${currentThemeColor}-300 transition-colors">${s}${i}</span>\n                        <span class="text-gray-500 text-xs ml-1">( ${r} )</span>\n                    </div>\n                </div>\n            `}}$("#natives-list").append(t),renderedCount=e}function switchTab(e){if("example"===e)$("#tab-content-example").removeClass("hidden").addClass("block"),$("#tab-content-source").addClass("hidden").removeClass("block"),$("#tab-btn-example").addClass(`border-${currentThemeColor}-500 text-white`).removeClass("border-transparent text-gray-500"),$("#tab-btn-source").removeClass(`border-${currentThemeColor}-500 text-white`).addClass("border-transparent text-gray-500"),currentNativeHash&&loadExampleCode(currentNativeHash);else if($("#tab-content-example").addClass("hidden").removeClass("block"),$("#tab-content-source").removeClass("hidden").addClass("block"),$("#tab-btn-source").addClass(`border-${currentThemeColor}-500 text-white`).removeClass("border-transparent text-gray-500"),$("#tab-btn-example").removeClass(`border-${currentThemeColor}-500 text-white`).addClass("border-transparent text-gray-500"),currentNativeHash&&"true"===$("#tab-btn-source").attr("data-has-source")){$("#source-code-viewer").text().startsWith("// 点击")&&loadSourceCode(currentNativeHash)}}function getGenericTypeColor(e){return""}function getTypeColorClass(e){return e?"void"===(e=e.replace("*","").toLowerCase())?"type-void":"int"===e||"hash"===e?"type-int":"float"===e?"type-float":"bool"===e||"boolean"===e?"type-bool":"vector3"===e?"type-vector3":["ped","vehicle","entity","object"].includes(e)?"type-entity":"text-gray-400":"text-gray-400"}function getApisetColor(e){return"client"===e?"bg-purple-900/50 text-purple-200 border-purple-700/50":"server"===e?"bg-orange-900/50 text-orange-200 border-orange-700/50":"shared"===e?"bg-blue-900/50 text-blue-200 border-blue-700/50":"bg-gray-700 text-gray-300"}function getApisetName(e){return"client"===e?"客户端":"server"===e?"服务器":"shared"===e?"共享":"未知"}function copyToClipboard(e){const t=$(e).text();if(navigator.clipboard)navigator.clipboard.writeText(t).then((()=>{$(e).text("已复制！"),setTimeout((()=>$(e).text(t)),1e3)}));else{const a=document.createElement("textarea");a.value=t,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),$(e).text("已复制！"),setTimeout((()=>$(e).text(t)),1e3)}}$(document).ready((function(){let e;marked.use({gfm:!0,breaks:!0}),$(".loading-overlay").fadeOut(),loadSettings(),checkLoginStatus(),fetchNatives(),initMonaco(),$("#search-input").on("input",(function(){clearTimeout(e),e=setTimeout((()=>filterData()),300)})),$("#filter-apiset, #filter-namespace").on("change",filterData),$("#natives-list").on("scroll",(function(){const e=$(this);e.scrollTop()+e.innerHeight()>=e[0].scrollHeight-200&&renderNextBatch()})),$(window).on("hashchange",(function(){const e=window.location.hash.slice(2);e&&selectNative(e)})),$("#btn-login").click((()=>{$("#modal-login").removeClass("hidden"),$("#input-username").focus()})),$("#user-info").click((()=>{currentUser&&($("#profile-avatar").attr("src",currentUser.avatar),$("#profile-name").text(currentUser.username),$("#profile-email").text(currentUser.email),$("#modal-user").removeClass("hidden"))})),$("#btn-change-pass").click((()=>{$("#modal-user").addClass("hidden"),$("#modal-change-pass").removeClass("hidden"),$("#input-old-pass").val(""),$("#input-new-pass").val(""),$("#input-confirm-pass").val(""),$("#input-old-pass").focus()})),$("#btn-submit-change-pass").click(submitChangePassword),$("#btn-submit-login").click(doLogin),$("#input-password").keypress((function(e){13==e.which&&doLogin()})),$("#btn-edit-trans").click((()=>{const e=allNatives.find((e=>e.hash===currentNativeHash))?.description_cn||"";$("#modal-trans").removeClass("hidden"),transEditor?(transEditor.setValue(e),setTimeout((()=>transEditor.layout()),50)):$("#input-trans-cn").val(e)})),$("#btn-submit-trans").click(submitTranslation),$("#btn-edit-code").click((()=>{if($("#modal-code").removeClass("hidden"),codeEditor){const e=$("#input-code-lang").val();updateCodeEditorLang(e);const t=currentNativeExamples[e]||"";codeEditor.setValue(t),setTimeout((()=>codeEditor.layout()),50)}})),$("#input-code-lang").on("change",(function(){if(codeEditor){const e=$(this).val();updateCodeEditorLang(e);const t=currentNativeExamples[e]||"";codeEditor.setValue(t)}})),$("#btn-submit-code").click(submitExample),$("#btn-edit-params").click((()=>{openParamsEditor()})),$("#btn-submit-params").click(submitParams),$("#btn-settings").click((()=>{$(`input[name="setting-game"][value="${userSettings.game}"]`).prop("checked",!0),$("#setting-lang").val(userSettings.lang),$("#setting-theme").val(userSettings.theme),$("#setting-highlight").val(userSettings.highlight),$("#modal-settings").removeClass("hidden")})),$("#btn-save-settings").click((()=>{userSettings.game=$('input[name="setting-game"]:checked').val(),userSettings.lang=$("#setting-lang").val(),userSettings.theme=$("#setting-theme").val(),userSettings.highlight=$("#setting-highlight").val(),saveSettings(),$("#modal-settings").addClass("hidden"),sendNotification("success","设置已保存"),filterData(),currentNativeHash&&selectNative(currentNativeHash),loadTheme(userSettings.theme||"blue"),loadHighlight(userSettings.highlight||"tomorrow")}));const t=$('meta[name="default-document"]').attr("content");t&&loadDefaultDocument(t),setInterval((function(){$("a").each((function(){const e=$(this).attr("href");!e||e.startsWith("#")||e.startsWith("/")||e.startsWith("./")||e.startsWith("?")||$(this).attr("target")&&"_blank"==$(this).attr("target")||$(this).attr("target","_blank")}))}),1e3),window.scrollTo(0,0)}));