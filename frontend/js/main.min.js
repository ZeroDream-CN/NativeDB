const API_BASE=document.querySelector('meta[name="api-base"]')?.content||window.location.origin;let allNatives=[],currentNativeHash=null,currentNativeParams=[],currentNativeExamples={},authToken=localStorage.getItem("native_db_token")||null,currentUser=null,transEditor=null,codeEditor=null,monacoLoaded=!1,renderQueue=[],renderedCount=0;const BATCH_SIZE=100;function initMonaco(){"undefined"!=typeof require&&(require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs"}}),require(["vs/editor/editor.main"],(function(){monacoLoaded=!0;const e=document.getElementById("editor-trans-cn");e&&(transEditor=monaco.editor.create(e,{value:"",language:"markdown",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on",fontSize:14,fontFamily:"'JetBrains Mono', Consolas, monospace"}));const t=document.getElementById("editor-code-content");t&&(codeEditor=monaco.editor.create(t,{value:"",language:"lua",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!0},scrollBeyondLastLine:!1,fontSize:14,fontFamily:"'JetBrains Mono', Consolas, monospace"}))})))}function updateCodeEditorLang(e){if(!codeEditor||!monacoLoaded)return;let t="lua";switch(e){case"c#":t="csharp";break;case"javascript":t="javascript";break;default:t="lua"}monaco.editor.setModelLanguage(codeEditor.getModel(),t)}function getAuthHeader(){return authToken?{Authorization:`Bearer ${authToken}`}:{}}async function checkLoginStatus(){if(authToken)try{const e=await fetch(`${API_BASE}/api/auth/me`,{headers:getAuthHeader()});e.ok?(currentUser=await e.json(),updateAuthUI(!0)):logout(!1)}catch(e){updateAuthUI(!1)}else updateAuthUI(!1)}function updateAuthUI(e){e&&currentUser?($("#btn-login").addClass("hidden"),$("#user-info").removeClass("hidden").addClass("flex"),$("#user-name").text(currentUser.username),$("#user-avatar").attr("src",currentUser.avatar),$("#btn-edit-trans").removeClass("hidden"),$("#btn-edit-code").removeClass("hidden"),$("#btn-edit-params").removeClass("hidden")):($("#btn-login").removeClass("hidden"),$("#user-info").addClass("hidden").removeClass("flex"),$("#btn-edit-trans").addClass("hidden"),$("#btn-edit-code").addClass("hidden"),$("#btn-edit-params").addClass("hidden"))}async function doLogin(){const e=$("#input-username").val().trim(),t=$("#input-password").val().trim();if(e&&t)try{const a=await fetch(`${API_BASE}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),n=await a.json();a.ok?(authToken=n.token,currentUser=n.user,localStorage.setItem("native_db_token",authToken),$("#modal-login").addClass("hidden"),$("#input-username").val(""),$("#input-password").val(""),updateAuthUI(!0),sendNotification("success",`欢迎回来, ${currentUser.username}`)):Swal.fire({icon:"error",title:"登录失败",theme:"material-ui-dark",text:n.error||"用户名或密码错误"})}catch(e){Swal.fire({icon:"error",title:"错误",theme:"material-ui-dark",text:"网络请求出错: "+e.message})}else Swal.fire({icon:"error",title:"错误",theme:"material-ui-dark",text:"请输入用户名和密码"})}async function submitChangePassword(){const e=$("#input-old-pass").val(),t=$("#input-new-pass").val(),a=$("#input-confirm-pass").val();if(e&&t&&a)if(t===a)if(t.length<6)Swal.fire({icon:"error",title:"错误",text:"新密码长度至少需要6位"});else try{const a=await fetch(`${API_BASE}/api/auth/change-password`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({old_password:e,new_password:t})}),n=await a.json();a.ok?(Swal.fire({icon:"success",title:"成功",text:"密码修改成功"}),$("#modal-change-pass").addClass("hidden")):Swal.fire({icon:"error",title:"错误",text:n.error||"修改失败"})}catch(e){Swal.fire({icon:"error",title:"错误",text:"网络请求失败: "+e.message})}else Swal.fire({icon:"error",title:"错误",text:"两次输入的新密码不一致"});else Swal.fire({icon:"error",title:"错误",text:"请填写所有字段"})}function logout(e=!0){authToken=null,currentUser=null,localStorage.removeItem("native_db_token"),e?location.reload():updateAuthUI(!1)}function sendNotification(e,t,a){Swal.fire({icon:e,theme:"material-ui-dark",text:t,showConfirmButton:!1,timer:2e3,position:"top-end"}).then((()=>{a&&a()}))}async function fetchNatives(){try{const e=await fetch(`${API_BASE}/api/natives`);if(!e.ok)throw new Error("API Error");allNatives=await e.json(),$("#status-bar").text(`已加载 ${allNatives.length} 个函数`),initFilters(),filterData();const t=window.location.hash.slice(2);t&&selectNative(t)}catch(e){$("#natives-list").html(`<div class="p-10 text-center text-red-500">加载函数失败<br>${e.message}</div>`)}}async function selectNative(e){currentNativeHash=e,currentNativeExamples={},$(".native-row").removeClass("active"),$(`#row-${e}`).addClass("active"),$("#empty-state").removeClass("md:flex").addClass("hidden"),$("#detail-container").removeClass("hidden"),$("#detail-view").removeClass("translate-x-full"),window.innerWidth<768&&$("body").addClass("overflow-hidden");const t=allNatives.find((t=>t.hash===e));t&&renderDetailBasic(t);try{const a=await fetch(`${API_BASE}/api/native/${e}`),n=await a.json();n.data&&(t&&(t.description_cn=n.data.description_cn,t.params=n.data.params),renderDetailFull(n.data,n.source_available),window.location.hash=`_${e}`)}catch(e){}}function closeMobileDetail(){$("#detail-view").addClass("translate-x-full"),$("body").removeClass("overflow-hidden"),$(".native-row").removeClass("active"),currentNativeHash=null,currentNativeExamples={},window.location.hash="",window.history.replaceState({},document.title,window.location.pathname)}function renderDetailBasic(e){currentNativeParams=e.params||[],$("#detail-name").text(e.name||e.hash),$("#detail-namespace").text(e.namespace),$("#detail-apiset").text(getApisetName(e.apiset)).attr("class",`px-2 py-0.5 rounded text-xs font-semibold border ${getApisetColor(e.apiset)}`),$("#detail-hash").text(e.hash),e.jhash?($("#detail-jhash").removeClass("hidden"),$("#detail-jhash").text(e.jhash)):$("#detail-jhash").addClass("hidden");const t=e.params.map((e=>`${e.type} ${e.name}`)).join(", "),a=`// ${e.name?toCamelCase(e.name):e.hash}\n${e.return_type} ${e.name||e.hash} (${t})`,n=$("#detail-definition");n.text(a),Prism.highlightElement(n[0]),renderParams(e.params),$("#detail-desc-cn").html('<span class="text-gray-600 italic">加载中...</span>'),$("#detail-desc-en").html(""),switchTab("example"),$("#source-code-viewer").text("// 点击 '底层源码' 标签以加载函数的底层代码。")}function toCamelCase(e){return e.toLowerCase().split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join("")}function renderParams(e){const t=$("#detail-params-list");t.empty(),e.forEach((e=>{let a=e.description_cn||e.description||"",n=marked.parse(a).replace(/<p>/g,"").replace(/<\/p>/g,"");const r=`\n                    <li class="param-item">\n                        <span class="text-zinc-400 mr-1 param-type type-${e.type}">${e.type}</span>\n                        <span class="text-white font-bold mr-1 param-name">${e.name}:</span>\n                        <span class="param-desc">${n}</span>\n                    </li>\n                `;t.append(r)})),0===e.length&&$("#detail-params-list").html('<li class="text-gray-500 italic">此函数没有参数。</li>')}function renderDetailFull(e,t){currentNativeParams=e.params||[],renderParams(currentNativeParams),e.description_cn&&""!==e.description_cn.trim()?$("#detail-desc-cn").html(marked.parse(e.description_cn)):e.description_original?$("#detail-desc-cn").html(marked.parse(e.description_original)):$("#detail-desc-cn").html('<span class="text-gray-600">暂无描述信息。</span>'),e.description_original&&$("#detail-desc-en").html(marked.parse(e.description_original)),$("#detail-desc-cn pre code, #detail-desc-en pre code").each(((e,t)=>Prism.highlightElement(t))),$("#detail-desc-en a, #detail-desc-cn a").each(((e,t)=>{const a=$(t).attr("href");a.startsWith("#")||a.startsWith("/")||$(t).attr("target","_blank")})),$("#tab-btn-source").attr("data-has-source",t?"true":"false"),t?$("#source-code-viewer").text("// 点击 '底层源码' 标签以加载函数的底层代码。"):$("#source-code-viewer").text("-- 数据库中暂无该函数的底层代码。"),authToken&&currentUser&&updateAuthUI(!0)}function formatCode(e){return js_beautify(e,{indent_size:4,indent_char:" ",brace_style:"collapse",preserve_newlines:!0,e4x:!0}).replaceAll(" - > ","->")}function cleanupCode(e){return e.split("\n").map((e=>e.trim())).join("\n")}async function loadSourceCode(e){const t=$("#source-code-viewer");t.text("// 正在加载中，请稍候...");try{const a=await fetch(`${API_BASE}/api/native/${e}/source`);if(404===a.status)return void t.text("// 数据库中暂无该函数的底层代码。");const n=cleanupCode((await a.json()).content);t.text(formatCode(n)),Prism.highlightElement(t[0])}catch(e){t.text("// 加载底层代码时发生错误。")}}async function loadExampleCode(e){const t=$("#example-code-viewer");t.text("// 正在加载中，请稍候..."),currentNativeExamples={};try{const a=await fetch(`${API_BASE}/api/native/${e}/example`);if(404===a.status)return void t.text("-- 数据库中暂无该函数的示例代码。");const n=await a.json();Array.isArray(n)&&n.forEach((e=>{e.language&&e.code&&(currentNativeExamples[e.language.toLowerCase()]=e.code)})),t.text(n?.[0]?.code||"-- 数据库中暂无该函数的示例代码。");const r=n?.[0]?.language||"lua";t.removeClass().addClass(`language-${r}`),Prism.highlightElement(t[0])}catch(e){t.text("// 加载示例代码时发生错误。"),currentNativeExamples={}}}async function submitTranslation(){if(!currentNativeHash)return;const e=transEditor?transEditor.getValue():$("#input-trans-cn").val(),t=`/api/native/${currentNativeHash}/translate`;try{const a=await fetch(`${API_BASE}${t}`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({description_cn:e})});if(a.ok){sendNotification("success","翻译保存成功！"),selectNative(currentNativeHash);const t=allNatives.find((e=>e.hash===currentNativeHash));t&&(t.description_cn=e),$("#modal-trans").addClass("hidden")}else{const e=await a.json();Swal.fire({icon:"error",title:"错误",text:"保存失败: "+(e.error||"未知错误")})}}catch(e){Swal.fire({icon:"error",title:"错误",text:"请求失败: "+e.message})}}async function submitExample(){if(!currentNativeHash)return;const e=$("#input-code-lang").val(),t=codeEditor?codeEditor.getValue():$("#input-code-content").val(),a=`/api/native/${currentNativeHash}/example`;try{const n=await fetch(`${API_BASE}${a}`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({language:e,code:t})});if(n.ok)sendNotification("success","示例代码保存成功！"),$("#modal-code").addClass("hidden"),loadExampleCode(currentNativeHash);else{const e=await n.json();Swal.fire({icon:"error",title:"错误",text:"保存失败: "+e.error})}}catch(e){Swal.fire({icon:"error",title:"错误",text:"请求失败: "+e.message})}}function openParamsEditor(){const e=$("#params-edit-container");e.empty(),currentNativeParams&&0!==currentNativeParams.length?currentNativeParams.forEach(((t,a)=>{const n=t.description||"(无原始描述)",r=t.description_cn||"",s=`\n                <div class="bg-gray-900 border border-gray-700 p-3 rounded">\n                    <div class="flex items-center gap-2 mb-2">\n                        <span class="text-blue-400 font-mono text-xs font-bold">${t.type}</span>\n                        <span class="text-white font-mono text-sm font-bold">${t.name}</span>\n                    </div>\n                    <div class="mb-2 text-xs text-gray-500 bg-gray-950 p-2 rounded border border-gray-800">\n                        <span class="font-bold text-gray-600 select-none">Original: </span>\n                        ${n}\n                    </div>\n                    <input type="text" \n                        class="param-input w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-indigo-500" \n                        placeholder="输入中文描述..." \n                        data-name="${t.name}" \n                        value="${r.replace(/"/g,"&quot;")}">\n                </div>\n            `;e.append(s)})):e.html('<div class="text-center text-gray-500 py-4">此函数没有参数，无需翻译。</div>'),$("#modal-params").removeClass("hidden")}async function submitParams(){if(!currentNativeHash)return;const e=[];$(".param-input").each((function(){const t=$(this).data("name"),a=$(this).val().trim();t&&e.push({name:t,description_cn:a})}));const t=`/api/native/${currentNativeHash}/params`;try{const a=await fetch(`${API_BASE}${t}`,{method:"POST",headers:{"Content-Type":"application/json",...getAuthHeader()},body:JSON.stringify({params:e})});if(a.ok){sendNotification("success","参数翻译保存成功！"),$("#modal-params").addClass("hidden"),selectNative(currentNativeHash);const t=allNatives.find((e=>e.hash===currentNativeHash));t&&t.params&&t.params.forEach((t=>{const a=e.find((e=>e.name===t.name));a&&(t.description_cn=a.description_cn)}))}else{const e=await a.json();Swal.fire({icon:"error",title:"错误",text:"保存失败: "+e.error})}}catch(e){Swal.fire({icon:"error",title:"错误",text:"请求失败: "+e.message})}}function initFilters(){const e=[...new Set(allNatives.map((e=>e.namespace)))].sort(),t=$("#filter-namespace");t.find('option:not([value="all"])').remove(),e.forEach((e=>t.append(`<option value="${e}">${e}</option>`)))}function filterData(){const e=$("#search-input").val().toLowerCase(),t=$("#filter-apiset").val(),a=$("#filter-namespace").val();let n=allNatives.filter((n=>{const r=n.name.toLowerCase().includes(e)||n.hash.toLowerCase().includes(e)||n.name.toLowerCase().replace(/_/g,"").includes(e),s="all"===t||n.apiset===t,o="all"===a||n.namespace===a;return r&&s&&o}));n.sort(((e,t)=>e.namespace!==t.namespace?e.namespace.localeCompare(t.namespace):e.name.localeCompare(t.name))),renderQueue=[];let r=null;n.forEach((e=>{e.namespace!==r&&(renderQueue.push({type:"header",text:e.namespace}),r=e.namespace),renderQueue.push({type:"row",data:e})}));const s=$("#natives-list");s.empty(),renderedCount=0,0===renderQueue.length?s.html('<div class="p-10 text-center text-gray-500">暂无符合条件的函数。</div>'):(renderNextBatch(),s.scrollTop(0))}function renderNextBatch(){if(renderedCount>=renderQueue.length)return;const e=Math.min(renderedCount+100,renderQueue.length);let t="";for(let a=renderedCount;a<e;a++){const e=renderQueue[a];if("header"===e.type)t+=`\n                <div class="sticky top-0 bg-gray-800/95 backdrop-blur border-b border-t border-gray-700 px-4 py-1.5 text-xs font-bold text-gray-400 uppercase tracking-wider z-0">\n                    ${e.text}\n                </div>\n            `;else{const a=e.data,n=a.params||[],r=n.map(((e,t)=>{const a=t===n.length-1;return`<span class="text-gray-400">${getGenericTypeColor(e.type)}${e.type}</span> <span class="text-gray-300 group-hover:text-white">${e.name}</span>${a?"":", "}`})).join(""),s=currentNativeHash===a.hash?"active":"";let o="";a.source_available&&(o+='<i class="fas fa-code text-yellow-400 text-xs ml-1" title="底层源码"></i>'),a.example_available&&(o+='<i class="fas fa-file-alt text-green-400 text-xs ml-1" title="示例代码"></i>'),t+=`\n                <div class="native-row cursor-pointer px-4 py-1.5 border-b border-gray-700/50 flex items-baseline gap-3 transition-colors group ${s}" \n                        onclick="selectNative('${a.hash}')" id="row-${a.hash}">\n                    <span class="text-xs font-mono font-bold shrink-0 w-16 text-right ${getTypeColorClass(a.return_type)}">${a.return_type}</span>\n                    <div class="flex-1 overflow-hidden whitespace-nowrap text-ellipsis font-mono text-sm text-gray-300 font-medium truncate">\n                        <span class="text-gray-100 group-hover:text-blue-300 transition-colors">${a.name||a.hash}${o}</span>\n                        <span class="text-gray-500 text-xs ml-1">( ${r} )</span>\n                    </div>\n                </div>\n            `}}$("#natives-list").append(t),renderedCount=e}function switchTab(e){if("example"===e)$("#tab-content-example").removeClass("hidden").addClass("block"),$("#tab-content-source").addClass("hidden").removeClass("block"),$("#tab-btn-example").addClass("border-blue-500 text-white").removeClass("border-transparent text-gray-500"),$("#tab-btn-source").removeClass("border-blue-500 text-white").addClass("border-transparent text-gray-500"),currentNativeHash&&loadExampleCode(currentNativeHash);else if($("#tab-content-example").addClass("hidden").removeClass("block"),$("#tab-content-source").removeClass("hidden").addClass("block"),$("#tab-btn-source").addClass("border-blue-500 text-white").removeClass("border-transparent text-gray-500"),$("#tab-btn-example").removeClass("border-blue-500 text-white").addClass("border-transparent text-gray-500"),currentNativeHash&&"true"===$("#tab-btn-source").attr("data-has-source")){$("#source-code-viewer").text().startsWith("// 点击")&&loadSourceCode(currentNativeHash)}}function getGenericTypeColor(e){return""}function getTypeColorClass(e){return e?"void"===(e=e.replace("*","").toLowerCase())?"type-void":"int"===e||"hash"===e?"type-int":"float"===e?"type-float":"bool"===e||"boolean"===e?"type-bool":"vector3"===e?"type-vector3":["ped","vehicle","entity","object"].includes(e)?"type-entity":"text-gray-400":"text-gray-400"}function getApisetColor(e){return"client"===e?"bg-purple-900/50 text-purple-200 border-purple-700/50":"server"===e?"bg-orange-900/50 text-orange-200 border-orange-700/50":"shared"===e?"bg-blue-900/50 text-blue-200 border-blue-700/50":"bg-gray-700 text-gray-300"}function getApisetName(e){return"client"===e?"客户端":"server"===e?"服务器":"shared"===e?"共享":"未知"}function copyToClipboard(e){const t=$(e).text();if(navigator.clipboard)navigator.clipboard.writeText(t).then((()=>{$(e).text("已复制！"),setTimeout((()=>$(e).text(t)),1e3)}));else{const a=document.createElement("textarea");a.value=t,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),$(e).text("已复制！"),setTimeout((()=>$(e).text(t)),1e3)}}$(document).ready((function(){let e;marked.use({gfm:!0,breaks:!0}),$(".loading-overlay").fadeOut(),checkLoginStatus(),fetchNatives(),initMonaco(),$("#search-input").on("input",(function(){clearTimeout(e),e=setTimeout((()=>filterData()),300)})),$("#filter-apiset, #filter-namespace").on("change",filterData),$("#natives-list").on("scroll",(function(){const e=$(this);e.scrollTop()+e.innerHeight()>=e[0].scrollHeight-200&&renderNextBatch()})),$(window).on("hashchange",(function(){const e=window.location.hash.slice(2);e&&selectNative(e)})),$("#btn-login").click((()=>{$("#modal-login").removeClass("hidden"),$("#input-username").focus()})),$("#user-info").click((()=>{currentUser&&($("#profile-avatar").attr("src",currentUser.avatar),$("#profile-name").text(currentUser.username),$("#profile-email").text(currentUser.email),$("#modal-user").removeClass("hidden"))})),$("#btn-change-pass").click((()=>{$("#modal-user").addClass("hidden"),$("#modal-change-pass").removeClass("hidden"),$("#input-old-pass").val(""),$("#input-new-pass").val(""),$("#input-confirm-pass").val(""),$("#input-old-pass").focus()})),$("#btn-submit-change-pass").click(submitChangePassword),$("#btn-submit-login").click(doLogin),$("#input-password").keypress((function(e){13==e.which&&doLogin()})),$("#btn-edit-trans").click((()=>{const e=allNatives.find((e=>e.hash===currentNativeHash))?.description_cn||"";$("#modal-trans").removeClass("hidden"),transEditor?(transEditor.setValue(e),setTimeout((()=>transEditor.layout()),50)):$("#input-trans-cn").val(e)})),$("#btn-submit-trans").click(submitTranslation),$("#btn-edit-code").click((()=>{if($("#modal-code").removeClass("hidden"),codeEditor){const e=$("#input-code-lang").val();updateCodeEditorLang(e);const t=currentNativeExamples[e]||"";codeEditor.setValue(t),setTimeout((()=>codeEditor.layout()),50)}})),$("#input-code-lang").on("change",(function(){if(codeEditor){const e=$(this).val();updateCodeEditorLang(e);const t=currentNativeExamples[e]||"";codeEditor.setValue(t)}})),$("#btn-submit-code").click(submitExample),$("#btn-edit-params").click((()=>{openParamsEditor()})),$("#btn-submit-params").click(submitParams),window.scrollTo(0,0)}));